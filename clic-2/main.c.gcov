        -:    0:Source:main.c
        -:    0:Programs:4
        -:    1:
        -:    2:#include <stdio.h>
        -:    3:#include <stdlib.h>
        -:    4:#include <sys/time.h>
        -:    5:#include <unistd.h>
        -:    6:#include <math.h>
        -:    7:#include <readline/readline.h>
        -:    8:#include <readline/history.h>
        -:    9:#include "parser.h"
        -:   10:
        -:   11:#define MAX_USER_VARS 1024
        -:   12:#define MAX_ID_LEN 64
        -:   13:
        -:   14:struct user_var {
        -:   15:	char name[MAX_ID_LEN + 1];
        -:   16:	double val;
        -:   17:} vars[MAX_USER_VARS];
        -:   18:
        -:   19:int slot = 0;
        -:   20:
        -:   21:PARSER *p;
        -:   22:EXPR *expr;
        -:   23:
function main called 1 returned 100% blocks executed 87%
        1:   24:int main(void)
        -:   25:{
        1:   26:	char *es = NULL;
        -:   27:	int k;
        -:   28:
     1025:   29:	for (k = 0; k < MAX_USER_VARS; k++) {
branch  0 taken 99%
branch  1 taken 1% (fallthrough)
     1024:   30:		memset(vars[k].name, 0, MAX_ID_LEN + 1);
     1024:   31:		vars[k].val = 0;
        -:   32:	};
        -:   33:
        1:   34:	p = parser_create(512, 128, 128, 512);
call    0 returned 100%
        1:   35:	if (!p) {
branch  0 taken 0% (fallthrough)
branch  1 taken 100%
    #####:   36:		printf("Error creating parser\n");
call    0 never executed
    #####:   37:		return 1;
        -:   38:	};
        -:   39:
        1:   40:	using_history();
call    0 returned 100%
        1:   41:	printf("Type '\\h' to get some help\n");
call    0 returned 100%
        -:   42:
        -:   43:	while (1) {
        -:   44:		char *cp1, *cp2;
        -:   45:		double r;
        -:   46:		char *infix;
        -:   47:
     1081:   48:		if (es)
branch  0 taken 99% (fallthrough)
branch  1 taken 1%
     1080:   49:			free(es);
     1081:   50:		es = readline("clic2> ");
call    0 returned 100%
     1081:   51:		if (!es)
branch  0 taken 0% (fallthrough)
branch  1 taken 100%
    #####:   52:			continue;
     1081:   53:		if (!*es)
branch  0 taken 0% (fallthrough)
branch  1 taken 100%
    #####:   54:			continue;
     1081:   55:		add_history(es);
call    0 returned 100%
        -:   56:
        -:   57:		/* special command */
     1081:   58:		if ((strlen(es) == 2) && (es[0] == '\\')) {
branch  0 taken 1% (fallthrough)
branch  1 taken 99%
branch  2 taken 80% (fallthrough)
branch  3 taken 20%
        4:   59:			switch (es[1]) {
branch  0 taken 25%
branch  1 taken 25%
branch  2 taken 25%
branch  3 taken 0%
branch  4 taken 25%
branch  5 taken 0%
        -:   60:			case 'q':
        1:   61:				goto __end;
        -:   62:			case 'v': 
        1:   63:				parser_print_varlist(p);
call    0 returned 100%
        1:   64:				continue;
        -:   65:			case 'f': 
        1:   66:				parser_print_funclist(p);
call    0 returned 100%
        1:   67:				continue;
        -:   68:			case 'c': 
    #####:   69:				parser_print_constlist(p);
call    0 never executed
    #####:   70:				continue;
        -:   71:			case 'h': 
        1:   72:				printf("\\v - variable list\n\\f - function list\n\\q - quit\n");
call    0 returned 100%
        1:   73:				continue;
        -:   74:			default:
    #####:   75:				printf("---unknown command\n");
call    0 never executed
    #####:   76:				continue;
        -:   77:			}
        -:   78:		}
        -:   79:
     1077:   80:		cp1 = strchr(es, '=');
     1077:   81:		cp2 = strrchr(es, '=');
     1077:   82:		if (cp1 != cp2) {
branch  0 taken 1% (fallthrough)
branch  1 taken 99%
        1:   83:			printf("---more than one '='\n");
call    0 returned 100%
        1:   84:			continue;
        -:   85:		}
        -:   86:
     1076:   87:		infix = es;
        -:   88:
        -:   89:		/* we have some assignment */
     1076:   90:		if (cp1) {
branch  0 taken 96% (fallthrough)
branch  1 taken 4%
     1032:   91:			cp1[0] = 0;
     1032:   92:			cp1++;
        -:   93:
        -:   94:			/**
        -:   95:			 *  TODO: add macro support
        -:   96:			 **/
        -:   97:
     1032:   98:			if (slot == MAX_USER_VARS) {
branch  0 taken 1% (fallthrough)
branch  1 taken 99%
        5:   99:				printf("---no more space left for variables\n");
call    0 returned 100%
        5:  100:				continue;
        -:  101:			}
     1027:  102:			if (strlen(es) > MAX_ID_LEN) {
branch  0 taken 1% (fallthrough)
branch  1 taken 99%
        1:  103:				printf("---identifier is too long\n");
call    0 returned 100%
        1:  104:				continue;
        -:  105:			}
     1026:  106:			memset(vars[slot].name, 0, MAX_ID_LEN + 1);
     1026:  107:			strcpy(vars[slot].name, es);
     1026:  108:			infix = cp1;
        -:  109:		}
        -:  110:
        -:  111:		/* calculate the expression */
     1070:  112:		expr = parser_create_expr(p, infix);
call    0 returned 100%
     1070:  113:		if (!expr) {
branch  0 taken 1% (fallthrough)
branch  1 taken 99%
        7:  114:			printf("---%s\n", parser_errorstr(p->error));
call    0 returned 100%
call    1 returned 100%
        7:  115:			continue;
        -:  116:		};
        -:  117:
        -:  118:		/** 
        -:  119:		 * uncomment the line below to see expressions in postfix notation
        -:  120:		 */
        -:  121:		// parser_print_expr_postfix(p, expr);
        -:  122:
     1063:  123:		r = parser_eval_expr(p, expr);
call    0 returned 100%
        -:  124:
     1063:  125:		if (cp1) {
branch  0 taken 97% (fallthrough)
branch  1 taken 3%
        -:  126:			VAR *v;
     1026:  127:			int exists = 0;
     1026:  128:			v = parser_create_var(p, vars[slot].name, &vars[slot].val, &exists);
call    0 returned 100%
     1026:  129:			if (!v) {
branch  0 taken 1% (fallthrough)
branch  1 taken 99%
        2:  130:				printf("---%s\n", parser_errorstr(p->error));
call    0 returned 100%
call    1 returned 100%
        2:  131:				continue;
        -:  132:			}
     1024:  133:			*(double*)v->loc = r;
     1024:  134:			if (!exists) /* new var */
branch  0 taken 100% (fallthrough)
branch  1 taken 0%
     1024:  135:				slot++;
        -:  136:		};
        -:  137:
     1061:  138:		printf("%.6f\n", r);
call    0 returned 100%
     1080:  139:	};
        -:  140:
        -:  141:      __end:
        1:  142:	parser_delete(p);
call    0 returned 100%
        1:  143:	return 0;
        -:  144:}
